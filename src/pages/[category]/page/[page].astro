---
import Layout from '../../../layouts/Layout.astro';
import NewsGrid from '../../../components/NewsGrid.astro';
import Pagination from '../../../components/Pagination.astro';
import { wpApi } from '../../../lib/wordpress';
import { CATEGORY_SLUGS, CATEGORY_LABELS } from '../../../lib/constants';
import type { CategorySlug } from '../../../lib/constants';

export async function getStaticPaths() {
  const paths: { params: { category: string; page: string } }[] = [];
  for (const category of CATEGORY_SLUGS) {
    try {
      const { totalPages } = await wpApi.getPostsByCategorySlug(category, { per_page: 10, page: 1 });
      for (let p = 2; p <= totalPages; p++) {
        paths.push({ params: { category, page: String(p) } });
      }
    } catch {
      // Skip si la API falla en build
    }
  }
  return paths;
}

interface Props {
  category: string;
  page: string;
}

const { category, page } = Astro.params as { category: CategorySlug; page: string };
const pageNum = Math.max(1, parseInt(page, 10) || 1);
const title = CATEGORY_LABELS[category] ?? category;
let posts: import('../../../types/wordpress').WpPostEmbedded[] = [];
let totalPages = 1;

try {
  const result = await wpApi.getPostsByCategorySlug(category, { per_page: 10, page: pageNum });
  posts = result.posts;
  totalPages = result.totalPages;
} catch {
  posts = [];
}

const baseUrl = `/${category}`;
---

<Layout title={`${title} - Página ${pageNum} | Fútbol Chimó`} description={`Noticias de ${title}, página ${pageNum}`}>
  <article class="space-y-12">
    <header>
      <h1 class="text-3xl font-bold tracking-tight text-white">{title}</h1>
      <p class="mt-2 text-white/60">Página {pageNum} de {totalPages}.</p>
    </header>

    <NewsGrid posts={posts} title="" />

    <Pagination baseUrl={baseUrl} currentPage={pageNum} totalPages={totalPages} />
  </article>
</Layout>
